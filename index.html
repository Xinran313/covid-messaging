<!DOCTYPE html>
<!--
Agasha Ratam
Version Jul 6, 2020
-->
<html>
	<head>
		<meta charset="utf-8">
		<title>Keywords by Issue</title>
		<script type="text/javascript" src="d3v5.js"></script>
		<link rel="stylesheet" href="style.css">
	</head>
	<body>
		<script type="text/javascript">
			var rowConverter = function(d) {
				return {
					ngram: d.ngram,

					dCount: parseFloat(d.pct_d),
					dExample1: d.d_example_1,
					dPerson1: d.d_person_1,
					dDate1: d.d_date_1,
					dExample2: d.d_example_2,
					dPerson2: d.d_person_2,
					dDate2: d.d_date_2,
					dExample3: d.d_example_3,
					dPerson3: d.d_person_3,
					dDate3: d.d_date_3,

					uCount: parseFloat(d.pct_u),
					uExample1: d.u_example_1,
					uPerson1: d.u_person_1,
					uDate1: d.u_date_1,
					uExample2: d.u_example_2,
					uPerson2: d.u_person_2,
					uDate2: d.u_date_2,
					uExample3: d.u_example_3,
					uPerson3: d.u_person_3,
					uDate3: d.u_date_3
				}
			}

			var bold = function(s, word) {
				return s;
			}

			var w = 1248;
			var h = 624;
			var pageMargin = 10;
			var gapY = 10;

			var titleHeight = 60;
			var dilemmasHeight = 60;
			var stancesHeight = 40;

			var midLabelGap = 150;
			var barHeight = 30;

			var tooltipBoxW = 550;
			var tooltipBoxH = 180;
			var tooltipGapX = 10;
			var tooltipGapY = 10;
			var tooltipBoxPadding = 10;
			var textTransition = 200;

			var sourceGap = 20;
			var sourcePos = 0.63;

			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h)
	
			// Title
			svg.append("rect")
				.attr("x", 0)
				.attr("y", 0)
				.attr("width", w)
				.attr("height", titleHeight);
			svg.append("text")
				.attr("id", "page-title")
				.attr("text-anchor", "middle")
				.attr("dominant-baseline", "central")
				.attr("x", w / 2)
				.attr("y", titleHeight / 2)
				.text("Most Frequent 2-grams by COVID-19 Dilemma");


			// Dilemmas
			svg.append("rect")
				.attr("class", "dilemma")
				.attr("x", 0)
				.attr("y", titleHeight + gapY)
				.attr("width", w)
				.attr("height", dilemmasHeight);
			svg.append("g")
				.attr("id", "dilemmas")
				.selectAll("rect")
				.data(new Array(5))
				.enter()
				.append("rect")
				.attr("class", function(d, i) {
					if (i == 0) {
						return "dilemma selected";
					}
					else {
						return "dilemma";
					}	
				})
				.attr("x", function(d, i) {
					return pageMargin + (w - 2 * pageMargin) * i / 5;
				})
				.attr("y", titleHeight + gapY)
				.attr("width", (w - 2 * pageMargin) / 5)
				.attr("height", dilemmasHeight);
			svg.append("g")
				.attr("id", "dilemma-labels")
				.selectAll("text")
				.data(["LOCKDOWN", "VENTILATORS / MEDICAL CARE", "PPE", "TRACK AND TRACE", "VACCINE"])
				.enter()
				.append("text")
				.attr("class", function(d, i) {
					if (i == 0) {
						return "dilemma selected";
					}
					else {
						return "dilemma";
					}
				})
				.attr("text-anchor", "middle")
				.attr("dominant-baseline", "central")
				.attr("x", function(d, i) {
					return pageMargin + (w - 2 * pageMargin) * (i + 0.5) / 5;
				})
				.attr("y", titleHeight + gapY + dilemmasHeight / 2)
				.text(function(d) {
					return d;
				});

			svg.append("g")
				.attr("id", "arguments")
				.selectAll("text")
				.data(["Deontological", "Utilitarian"])
				.enter()
				.append("text")
				.attr("class", function(d, i) {
					classes = ["stance deontological", "stance utilitarian"];
					return classes[i];
				})
				.attr("text-anchor", "middle")
				.attr("dominant-baseline", "central")
				.attr("x", function(d, i) {
					return w / 2 + (2 * i - 1) * (w / 2 - pageMargin) / 2;
				})
				.attr("y", titleHeight + dilemmasHeight + 2 * gapY + stancesHeight / 2)
				.text(function(d) {
					return d;
				});

			Promise.all([
				d3.csv("lockdown.csv", rowConverter),
				d3.csv("medical_care.csv", rowConverter),
				d3.csv("ppe.csv", rowConverter),
				d3.csv("trace.csv", rowConverter),
				d3.csv("vaccine.csv", rowConverter)
			])
			.then(function(datasets) {
				dataset = datasets[0];

				var maxPct = d3.max(datasets.map(function(dataset) {
					return d3.max(dataset.map(function(d) {
						return d3.max([d.dCount, d.uCount]);
					}));
				}));
				maxPct = 0.25 * maxPct;

				var xScale = d3.scaleLinear()
								.domain([0, maxPct])
								.rangeRound([0, w / 2 - pageMargin - 100]);

				guides = [-maxPct, -maxPct * 3/4, -maxPct / 2, -maxPct / 4, 0, maxPct / 4, maxPct / 2, maxPct * 3 / 4, maxPct];
				guides = [-3, -2, -1, 0, 1, 2, 3]

				svg.append("g")
					.selectAll("line")
					.data(guides)
					.enter()
					.append("line")
					.attr("x1", function(d) {
						return w / 2 + xScale(d);
					})
					.attr("x2", function(d) {
						return w / 2 + xScale(d);
					})
					.attr("y1", titleHeight + dilemmasHeight + stancesHeight + 3 * gapY)
					.attr("y2", h - gapY)
					.style("stroke", function(d, i) {
						if (i == 3) {
							return "#222222";
						}
						else {
							return "#dddddd";
						}
					});


				svg.append("g")
					.attr("id", "line-labels")
					.selectAll("text")
					.data(guides)
					.enter()
					.append("text")
					.attr("text-anchor", "middle")
					.attr("dominant-baseline", "top")
					.attr("x", function(d) {
						return w / 2 + xScale(d);
					})
					.attr("y", h - gapY + 10)
					.text(function(d) {
						return Math.round(Math.abs(d) * 1000) / 1000 + "%";
					});


				// Bar labels
				svg.append("g")
					.attr("id", "bar-labels-left")
					.selectAll("text")
					.data(dataset)
					.enter()
					.append("text")
					.attr("class", "row-plot")
					.attr("text-anchor", "end")
					.attr("dominant-baseline", "central")
					.attr("x", function(d) {
						return w / 2 - xScale(d.dCount) - 10;
					})
					.attr("y", function(d, i) {
						labelsHeight = (h - gapY) - (titleHeight + dilemmasHeight + stancesHeight + 3 * gapY);
						return titleHeight + dilemmasHeight + stancesHeight + 3 * gapY + labelsHeight * (i + 0.5) / dataset.length;
					})
					.text(function(d) {
						if (d.dCount >= d.uCount) {
							return d.ngram;
						}
						else {
							return "";
						}
					});

				svg.append("g")
					.attr("id", "bar-labels-right")
					.selectAll("text")
					.data(dataset)
					.enter()
					.append("text")
					.attr("class", "row-plot")
					.attr("dominant-baseline", "central")
					.attr("x", function(d) {
						return w / 2 + xScale(d.uCount) + 10;
					})
					.attr("y", function(d, i) {
						labelsHeight = (h - gapY) - (titleHeight + dilemmasHeight + stancesHeight + 3 * gapY);
						return titleHeight + dilemmasHeight + stancesHeight + 3 * gapY + labelsHeight * (i + 0.5) / dataset.length;
					})
					.text(function(d) {
						if (d.dCount >= d.uCount) {
							return "";
						}
						else {
							return d.ngram;
						}
					});


				svg.append("g")
					.attr("id", "deon-bars")
					.selectAll("rect")
					.data(dataset)
					.enter()
					.append("rect")
					.attr("class", "row-plot deontological")
					.attr("x", function(d) {
						return w / 2 - xScale(d.dCount);
					})
					.attr("y", function(d, i) {
						labelsHeight = (h - gapY) - (titleHeight + dilemmasHeight + stancesHeight + 3 * gapY);
						return titleHeight + dilemmasHeight + stancesHeight + 3 * gapY + labelsHeight * (i + 0.2) / dataset.length;
					})
					.attr("width", function(d) {
						return xScale(d.dCount);
					})
					.attr("height",	0.6 * ((h - gapY) - (titleHeight + dilemmasHeight + 2 * gapY)) / dataset.length)
					.attr("word", function(d) {
						return d.ngram;
					})
					.on("mouseover", function() {
						var x = parseFloat(d3.select(this).attr("x"))
						var y = parseFloat(d3.select(this).attr("y"))
						var w = parseFloat(d3.select(this).attr("width"))

						d3.select(this).style("stroke-width", "2px");

						svg.append("rect")
							.attr("id", "tooltip-box")
							.attr("x", x + w / 2)
							.attr("y", y)
							.attr("width", 0)
							.attr("height", 0);
					})
					.on("click", function() {
						var x = parseFloat(d3.select(this).attr("x"));
						var y = parseFloat(d3.select(this).attr("y"));
						var word = d3.select(this).attr("word");

						svg.select("#tooltip-box")
							.transition()
							.duration(textTransition)
							.attr("x", x -  tooltipGapX)
							.attr("y", y - tooltipBoxH - tooltipGapY)
							.attr("width", tooltipBoxW)
							.attr("height", tooltipBoxH)

						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding)
							.attr("y", y - tooltipBoxH - tooltipGapY)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.dExample1 != "") {
										res = "\"" + d.dExample1.replaceAll("<b>", "<b class=\"deontological\">") + "\"";
									}
								});

								return res;
							})
							.transition()
							.delay(textTransition)
							.attr("class", null);

						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding + sourcePos * tooltipBoxW)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH / 3 - sourceGap)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.dExample1 != "") {
										res = "- " + d.dPerson1 + " (" + d.dDate1 + ")";
									}
								});

								return res;
							})
							.transition()
                            .delay(textTransition)
                            .attr("class", null);

						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH / 3)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.dExample2 != "") {
										res = "\"" + d.dExample2.replaceAll("<b>", "<b class=\"deontological\">") + "\"";
									}
								});

								return res;
							})
							.transition()
                            .delay(textTransition)
                            .attr("class", null);

						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding + sourcePos * tooltipBoxW)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH * 2 / 3 - sourceGap)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.dExample2 != "") {
										res = "- " + d.dPerson2 + " (" + d.dDate2 + ")";
									}
								});

								return res;
							})
							.transition()
                            .delay(textTransition)
                            .attr("class", null);

						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH * 2 / 3)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.dExample3 != "") {
										res = "\"" + d.dExample3.replaceAll("<b>", "<b class=\"deontological\">") + "\"";
									}
								});

								return res;
							})
							.transition()
                            .delay(textTransition)
                            .attr("class", null);

						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding + sourcePos * tooltipBoxW)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH  - sourceGap)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.dExample3 != "") {
										res = "- " + d.dPerson3 + " (" + d.dDate3 + ")";
									}
								});

								return res;
							})
							.transition()
                            .delay(textTransition)
                            .attr("class", null);
					})
					.on("mouseout", function() {
						d3.select(this).style("stroke-width", "0.3px");

						d3.select(this).attr("stroke-width", "0.3");
						d3.selectAll("#tooltip-box").remove();
						d3.selectAll("#tooltip").remove();
					});

				svg.append("g")
					.attr("id", "util-bars")
					.selectAll("rect")
					.data(dataset)
					.enter()
					.append("rect")
					.attr("class", "row-plot utilitarian")
					.attr("x", function(d) {
						return w / 2;
					})
					.attr("y", function(d, i) {
						labelsHeight = (h - gapY) - (titleHeight + dilemmasHeight + stancesHeight + 3 * gapY);
						return titleHeight + dilemmasHeight + stancesHeight + 3 * gapY + labelsHeight * (i + 0.2) / dataset.length;
					})
					.attr("width", function(d) {
						return xScale(d.uCount);
					})
					.attr("height",	0.6 * ((h - gapY) - (titleHeight + dilemmasHeight + 2 * gapY)) / dataset.length)
					.attr("word", function(d) {
						return d.ngram;
					})
					.on("mouseover", function() {
						var x = parseFloat(d3.select(this).attr("x"))
						var y = parseFloat(d3.select(this).attr("y"))
						var w = parseFloat(d3.select(this).attr("width"))

						d3.select(this).style("stroke-width", "2px");

						svg.append("rect")
							.attr("id", "tooltip-box")
							.attr("x", x + w / 2)
							.attr("y", y)
							.attr("width", 0)
							.attr("height", 0);

					})
					.on("click", function() {
						var x = parseFloat(d3.select(this).attr("x"));
						var y = parseFloat(d3.select(this).attr("y"));
						var word = d3.select(this).attr("word");

						svg.select("#tooltip-box")
							.transition()
							.duration(textTransition)
							.attr("id", "tooltip-box")
							.attr("x", x -  tooltipGapX)
							.attr("y", y - tooltipBoxH - tooltipGapY)
							.attr("width", tooltipBoxW)
							.attr("height", tooltipBoxH)

						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding)
							.attr("y", y - tooltipBoxH - tooltipGapY)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.uExample1 != "") {
										res = "\"" + d.uExample1.replaceAll("<b>", "<b class=\"utilitarian\">") + "\"";
									}
								});

								return res;
							})
							.transition()
							.delay(textTransition)
							.attr("class", null);


						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding + sourcePos * tooltipBoxW)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH / 3 - sourceGap)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.uExample1 != "") {
										res = "- " + d.uPerson1 + " (" + d.uDate1 + ")";
									}
								});

								return res;
							})
							.transition()
							.delay(textTransition)
							.attr("class", null);


						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH / 3)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.uExample2 != "") {
										res = "\"" + d.uExample2.replaceAll("<b>", "<b class=\"utilitarian\">") + "\"";
									}
								});

								return res;
							})
							.transition()
							.delay(textTransition)
							.attr("class", null);


						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding + sourcePos * tooltipBoxW)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH * 2 / 3 - sourceGap)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.uExample2 != "") {
										res = "- " + d.uPerson2 + " (" + d.uDate2 + ")";
									}
								});

								return res;
							})
							.transition()
							.delay(textTransition)
							.attr("class", null);


						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH * 2 / 3)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")
							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.uExample3 != "") {
										res = "\"" + d.uExample3.replaceAll("<b>", "<b class=\"utilitarian\">") + "\"";
									}
								});

								return res;
							})
							.transition()
							.delay(textTransition)
							.attr("class", null);


						svg.append("foreignObject")
							.attr("id", "tooltip")
							.attr("x", x - tooltipGapX + tooltipBoxPadding + sourcePos * tooltipBoxW)
							.attr("y", y - tooltipBoxH - tooltipGapY + tooltipBoxH  - sourceGap)
							.attr("width", tooltipBoxW - 2 * tooltipBoxPadding)
							.attr("height", tooltipBoxH / 4)
							.append("xhtml:div")
							.attr("class", "invisible")

							.html(function() {
								res = ""
								dataset.forEach(function(d) {
									if (d.ngram === word && d.uExample3 != "") {
										res = "- " + d.uPerson3 + " (" + d.uDate3 + ")";
									}
								});

								return res;
							})
							.transition()
							.delay(textTransition)
							.attr("class", null);


					})
					.on("mouseout", function() {
						d3.select(this).style("stroke-width", "0.3px");

						d3.select(this).attr("stroke-width", "0.3");
						d3.selectAll("#tooltip-box").remove();
						d3.selectAll("#tooltip").remove();
					});

				d3.select("#dilemmas")
					.selectAll("rect")
					.on("click", function(d, i) {
						dataset = datasets[i];

						d3.select("#dilemmas")
							.selectAll("rect")
							.attr("class", function(d2, i2) {
								if (i === i2) {
									return "dilemma selected";
								}
								else {
									return "dilemma";
								}
							});

						d3.select("#dilemma-labels")
							.selectAll("text")
							.attr("class", function(d2, i2) {
								if (i === i2) {
									return "dilemma selected";
								}
								else {
									return "dilemma";
								}
							});

						d3.select("#bar-labels-left")
							.selectAll("text")
							.data(dataset)
							.transition()
							.duration(1000)
							.attr("x", function(d) {
								return w / 2 - xScale(d.dCount) - 10;
							})
							.text(function(d) {
								if (d.dCount >= d.uCount) {
									return d.ngram;
								}
								else {
									return "";
								}
							});

						d3.select("#bar-labels-right")
							.selectAll("text")
							.data(dataset)
							.transition()
							.duration(1000)
							.attr("x", function(d) {
								return w / 2 + xScale(d.uCount) + 10;
							})
							.text(function(d) {
								if (d.dCount > d.uCount) {
									return "";
								}
								else {
									return d.ngram;
								}
							});

						d3.select("#deon-bars")
							.selectAll("rect")
							.data(dataset)
							.transition()
							.duration(1000)
							.attr("x", function(d) {
								return w / 2 - xScale(d.dCount);
							})
							.attr("width", function(d) {
								return xScale(d.dCount);
							})
							.attr("word", function(d) {
								return d.ngram;
							});

						d3.select("#util-bars")
							.selectAll("rect")
							.data(dataset)
							.transition()
							.duration(1000)
							.attr("width", function(d) {
								return xScale(d.uCount);
							})
							.attr("word", function(d) {
								return d.ngram;
							});
					});


			})
			.catch(function(err) {
				console.log("Error: " + err);
			});

		</script>
	</body>
</html>
